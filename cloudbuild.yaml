# Google Cloud Build 配置文件
# 用于构建和部署 MyShell 2025 开发者年度回顾项目

steps:
  # 步骤 1: 使用 Docker 构建镜像（注入 API Key 作为构建参数）
  - name: 'gcr.io/cloud-builders/docker'
    args: [
      'build',
      '--build-arg', 'GEMINI_API_KEY=${_GEMINI_API_KEY}',
      '-t', 'gcr.io/$PROJECT_ID/myshell-recap:$COMMIT_SHA',
      '-t', 'gcr.io/$PROJECT_ID/myshell-recap:latest',
      '.'
    ]
    id: 'build-image'

  # 步骤 2: 推送镜像到 Container Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/myshell-recap:$COMMIT_SHA']
    id: 'push-image'
    waitFor: ['build-image']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/myshell-recap:latest']
    id: 'push-latest'
    waitFor: ['build-image']

  # 步骤 3: 部署到 Cloud Run
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: gcloud
    args: [
      'run', 'deploy', 'myshell2025recap',
      '--image', 'gcr.io/$PROJECT_ID/myshell-recap:$COMMIT_SHA',
      '--region', 'europe-west1',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--port', '8080'
    ]
    id: 'deploy-cloudrun'
    waitFor: ['push-image']

# 超时时间（顶层配置）
timeout: '1800s'  # 30 分钟

# 构建选项
options:
  # 使用 CLOUD_LOGGING_ONLY 来解决 service_account 配置问题
  logging: CLOUD_LOGGING_ONLY

  # 机器类型（可选，根据项目大小调整）
  machineType: 'N1_HIGHCPU_8'

# 构建产物（可选）
# artifacts:
#   objects:
#     location: 'gs://your-bucket-name/build-artifacts'
#     paths: ['dist/**']

# 替换变量（Substitution Variables）
# 需要在 Cloud Build 触发器中配置以下变量：
# _GEMINI_API_KEY: 你的 Gemini API Key
#
# 配置方法：
# 1. 打开 Cloud Console -> Cloud Build -> 触发器
# 2. 编辑触发器
# 3. 展开 "高级" 部分
# 4. 在 "替换变量" 中添加：
#    变量名: _GEMINI_API_KEY
#    值: 你的新 Gemini API Key（从 https://aistudio.google.com/app/apikey 获取）
# 5. 保存触发器
#
# ⚠️ 安全提醒：切勿在此文件中明文写入 API Key
